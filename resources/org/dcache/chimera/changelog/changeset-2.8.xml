<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
     http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd">

    <changeSet author="tigran" id="14">
        <addColumn tableName="t_inodes">
            <column name="icrtime" type="DATETIME" remarks="file/directory creation timestamp"/>
        </addColumn>
    </changeSet>

    <changeSet author="tigran" id="15">
        <sql stripComments="true">
            UPDATE t_inodes SET icrtime = (
                SELECT
                    CASE
                        WHEN ictime &lt;= imtime and ictime &lt;= iatime THEN ictime
                        WHEN imtime &lt;= ictime and imtime &lt;= iatime THEN imtime
                        ELSE iatime
                    END AS icrtime
                FROM t_inodes AS p WHERE p.ipnfsid = t_inodes.ipnfsid
            )
        </sql>
    </changeSet>

    <changeSet author="tigran" id="16">
        <addNotNullConstraint columnDataType="DATETIME"
                      columnName="icrtime"
                      tableName="t_inodes"/>
    </changeSet>
</databaseChangeLog>
