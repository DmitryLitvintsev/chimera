<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog
     xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
     xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
     http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <changeSet author="tigran" id="7" dbms="postgresql">
        <createProcedure>
            DROP TRIGGER IF EXISTS tgr_insertACL ON t_dirs;

            CREATE OR REPLACE FUNCTION f_insertACL() RETURNS trigger AS $$
            DECLARE
                msk INTEGER;
                flag INTEGER;
                rstype INTEGER;
                id character(36);
                parentid character(36);

            BEGIN
                IF (TG_OP = 'INSERT') THEN
                    msk := 0;
                    SELECT INTO rstype itype FROM t_inodes WHERE ipnfsid = NEW.ipnfsid;

                    IF rstype = 32768  THEN
                        id := NEW.ipnfsid;
                        parentid := NEW.iparent;
                        rstype := 1;    -- inserted object is a file
                        flag := 1;      -- check flags for 'f' bit
                        msk := 11;      -- mask contains 'o','d' and 'f' bits

                    ELSIF (rstype = 16384 AND NEW.iname = '..') THEN
                        id := NEW.iparent;
                        parentid := NEW.ipnfsid;
                        rstype := 0;    -- inserted object is a directory
                        flag := 3;      -- check flags for 'd' and 'f' bits
                        msk := 8;       -- mask contains 'o' bit
                    END IF;

                    IF msk > 0 THEN

                        INSERT INTO t_acl
                        SELECT id, rstype, type, (flags | msk) # msk, access_msk, who, who_id, address_msk, ace_order
                        FROM t_acl
                        WHERE  rs_id = parentid AND ((flags &amp; flag) > 0);
                    END IF;
                END IF;
                RETURN NULL;
            END;
            $$ LANGUAGE plpgsql;

            CREATE TRIGGER  tgr_insertACL AFTER INSERT ON  t_dirs FOR EACH ROW EXECUTE PROCEDURE  f_insertACL();
        </createProcedure>
    </changeSet>

    <changeSet author="tigran" id="8">
        <!-- DEAD changeSet. Enforce new checksum -->
        <validCheckSum>3:d41d8cd98f00b204e9800998ecf8427e</validCheckSum>
    </changeSet>
</databaseChangeLog>
